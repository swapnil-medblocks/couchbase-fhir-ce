# Version and Build Information Setup

## Problem Identified

Your GitHub Actions workflow only tags Docker images as `:latest` when the **version in `backend/pom.xml` changes**. When you make fixes without bumping the version:

1. GitHub Actions skips the build (unless manually triggered)
2. Even with manual trigger, images are only tagged with the commit SHA (e.g., `:a1b2c3d`), not `:latest`
3. Your `install.sh` script pulls `:latest` by default
4. Users get the old cached image because `:latest` wasn't updated
5. The version displayed was always `0.9.0-beta.1`, making it impossible to verify which build is running

## Solution Implemented

### Backend Changes

**File: `backend/src/main/java/com/couchbase/admin/config/controller/ConfigController.java`**

- Added `buildTime` field to capture when the application was built
- Updated the `/api/config/version` endpoint to return:
  - `version` - from pom.xml
  - `buildTime` - ISO 8601 timestamp when the build was created
  - `name`, `group`, `artifact` - additional build metadata

This information is automatically generated by Maven's `spring-boot-maven-plugin` with the `build-info` goal (already configured in your `pom.xml`).

### Frontend Changes

**File: `frontend/src/services/versionService.ts`**

- Updated `BackendVersionInfo` interface to include build metadata
- Modified `fetchBackendVersion()` to retrieve and return build time

**File: `frontend/src/pages/Dashboard/DashboardFhirServer.tsx`**

- Added state for `buildTime`
- Created `formatBuildTime()` function to format ISO timestamps as readable dates
- Updated the version display to show: `Version: 0.9.0-beta.1 (built: Jan 15, 2025, 3:45 PM EST)`

## How This Helps

Now when you deploy a new build, you'll see something like:

```
Version: 0.9.0-beta.1 (built: Oct 12, 2025, 10:30 AM PST)
```

Each new build will have a different timestamp, making it immediately obvious whether you're running the latest version or an old cached image.

## Workflow Recommendations

You have two options for managing versions going forward:

### Option 1: Bump Version for Each Fix (Recommended)

**Best for:** Production systems, when you want clear version tracking

Update the version in `backend/pom.xml` after each significant fix:

```xml
<version>0.9.0-beta.2</version>  <!-- Increment after fixes -->
```

**Benefits:**

- Images are tagged with version number AND `:latest`
- Clear version history in Docker registry
- Easy rollback to specific versions
- Automatic builds on version change

### Option 2: Use Build Timestamp Only

**Best for:** Rapid development, frequent small fixes

Keep the same version but rely on the build timestamp to differentiate builds.

**To ensure `:latest` tag is updated:**

1. Manually trigger the workflow from GitHub Actions UI
2. OR modify your workflow to always update `:latest` on manual trigger

To modify the workflow, change line 78-79 in `.github/workflows/couchbase-fhir-publish.yml`:

```yaml
else
  # Add :latest even when version hasn't changed
  echo "SERVER_TAGS=${{ env.REGISTRY }}/${{ github.repository }}/fhir-server:${SHA},${{ env.REGISTRY }}/${{ github.repository }}/fhir-server:latest" >> $GITHUB_OUTPUT
  echo "ADMIN_TAGS=${{ env.REGISTRY }}/${{ github.repository }}/fhir-admin:${SHA},${{ env.REGISTRY }}/${{ github.repository }}/fhir-admin:latest"   >> $GITHUB_OUTPUT
fi
```

## Current Workflow Behavior

From `.github/workflows/couchbase-fhir-publish.yml`:

| Scenario                            | Triggers Build? | Image Tags                     |
| ----------------------------------- | --------------- | ------------------------------ |
| Version changed in pom.xml          | ✅ Yes          | `{version}`, `{SHA}`, `latest` |
| Version unchanged, commit to master | ❌ No           | N/A                            |
| Manual workflow dispatch            | ✅ Yes          | `{SHA}` only                   |
| Tagged release (v\*)                | ✅ Yes          | `{tag}`, `{SHA}` (no latest)   |

## Testing Your Changes

After deploying these changes:

1. Build and deploy locally to test
2. Check the Dashboard - you should see the build timestamp
3. The timestamp will update each time you rebuild
4. This confirms you're running the latest build

## Example Display

Before:

```
Version: 0.9.0-beta.1
```

After:

```
Version: 0.9.0-beta.1 (built: Oct 12, 2025, 2:30 PM PDT)
```

Now you can always verify which build you're running!
