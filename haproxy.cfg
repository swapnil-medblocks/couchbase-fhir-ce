#####################################################################
# Minimal HAProxy config for beta (frontend + backend only)
#
# Routes:
#   / or any non /api /fhir path -> frontend service (fhir-admin)
#   /api/* and /fhir/*            -> backend service (fhir-server)
#
# If the backend expects its resources without the leading /api or /fhir
# uncomment the "http-request replace-path" line inside backend-fhir-server.
#
# Exposes stats at /haproxy?stats (user: admin pass: admin)
#####################################################################

global
    log stdout format raw daemon
    # Runtime socket disabled for now (was causing Permission denied). Re-enable later if needed.
    # stats socket /tmp/haproxy/haproxy.sock mode 600 level admin

defaults
    mode http
    log global
    option httplog
    option dontlognull
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout http-request 5s

frontend http-in
    bind *:80
    option forwardfor
    option http-server-close
    option dontlognull     # Don't log null connections
    option dontlog-normal  # Don't log successful requests (2xx/3xx)

    # Stats UI and API
    stats uri /haproxy?stats
    stats refresh 5s
    stats auth admin:admin
    stats show-legends

    # ACLs to detect API / FHIR traffic
    acl is_api path_beg /api /fhir
    acl is_auth path_beg /auth
    use_backend backend-fhir-server if is_api
    use_backend backend-auth-server if is_auth
    default_backend backend-fhir-admin
    # default_backend backend-fhir-server
    
backend backend-fhir-admin
    balance roundrobin
    option httpchk HEAD /
    option dontlog-normal
    server frontend fhir-admin:80 check

backend backend-fhir-server
    balance roundrobin
    # Set X-Forwarded-Proto headers
    http-request set-header X-Forwarded-Proto http
    http-request set-header X-Forwarded-Proto https if { ssl_fc }

    # If backend should NOT receive the /api or /fhir prefix, enable one of:
    # http-request replace-path ^/(api|fhir)(/)?(.*)$ /\3
    # Otherwise leave commented and backend sees /api/... or /fhir/...

    option httpchk GET /actuator/health
    option dontlog-normal
    server backend fhir-server:8080 check

backend backend-auth-server
    balance roundrobin
    http-request set-header X-Forwarded-Proto http
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    server backend auth-server:5000 check
# End of file
